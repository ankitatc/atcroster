<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ===== Modal Styling ===== */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
  }

  .modal-content {
    background: #fff;
    padding: 24px;
    border-radius: 12px;
    width: 320px;
    box-shadow: 0 8px 20px rgba(0,0,0,.25);
    animation: fadeIn 0.3s ease-in-out;
  }

  .modal-content h2 {
    font-size: 20px;
    font-weight: 700;
    color: #ad1a8d;
  }

  .modal-content p {
    font-size: 14px;
    color: #971e9c;
    margin-bottom: 12px;
  }

  .close {
    float: right;
    font-size: 22px;
    cursor: pointer;
    color: #999;
  }
  .close:hover { color: #333; }

  /* Shake animation for wrong password */
  @keyframes shake {
    0% { transform: translateX(0); }
    20% { transform: translateX(-8px); }
    40% { transform: translateX(8px); }
    60% { transform: translateX(-6px); }
    80% { transform: translateX(6px); }
    100% { transform: translateX(0); }
  }
  .shake {
    animation: shake 0.4s;
    border: 2px solid red !important;
  }

    :root{
      --brand1:#83f781;
      --brand2:#d8f781;
      --primary:#42ebe8;
      --pillText:#000;
      --headerShadow:0 6px 18px rgba(0,0,0,.15);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans";
      background:#f5f7fa;
      color:#111827;
    }

    /* ===== Header ===== */
    .topbar{
      background:linear-gradient(90deg,var(--brand1),var(--brand2));
      color:#fff;border-radius:12px;margin:16px;padding:16px 20px;
      display:flex;align-items:center;justify-content:space-between;box-shadow:var(--headerShadow);
    }
    .titleWrap{display:flex;align-items:center;gap:12px;}
    .logo{width:32px;height:32px;border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;color:#0ea5e9;}
    .title{font-weight:800;font-size:22px;letter-spacing:.2px;}
    .subtitle{font-size:12px;opacity:.9;margin-top:2px;}

    /* Mode toggle */
    .modes{display:flex;gap:8px;align-items:center;}
    .mode-button {
      background: #2563eb;      /* blue */
      color: white;
      border: none;
      border-radius: 6px;
      padding: 14px 24px;       /* ðŸ”¥ increase vertical padding (14px) */
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin: 8px;
      transition: background 0.2s;
    }

    .mode-button:hover {
      background: #1d4ed8;      /* darker blue on hover */
    }

    .active{ background:#ffcc00;color:#111;}
    .inactive{ background:#e5e7eb;color:#374151;}

    /* Actions */
    .actions{display:flex;gap:10px;align-items:center;margin:10px 16px 0 16px;justify-content:flex-end;}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:8px;padding:9px 14px;font-weight:700;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,.15);transition:.2s;}
    .btn:hover{filter:brightness(0.95)}
    .btn.warn{background:#f59e0b}

    /* Search + badge */
    .searchRow{display:flex;gap:20px;align-items:center;margin:12px 16px;justify-content:space-between;flex-wrap:wrap;}
    .search{flex:1;min-width:260px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;box-shadow:0 2px 8px rgba(0,0,0,.06);}
    .modeBadge{padding:8px 12px;background:#e5e7eb;border-radius:999px;font-weight:700;color:#374151;min-width:max-content;}

    /* Table wrapper: proper horizontal scroll */
    .tableWrap{
      background:#fff;border-radius:12px;margin:0 16px 16px;
      overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
    }

    table{
      width:max-content;    /* grows with content to enable horizontal scroll */
      min-width:100%;       /* but never smaller than container */
      border-collapse:separate;border-spacing:0;
    }
    th, td{border-bottom:1px solid #e5e7eb;padding:10px;text-align:center;white-space:nowrap;min-width:90px;}
    thead th{position:sticky;top:0;background:#d8f781;color:#fff;z-index:1}

    /* Pills */
    .pill{
      display:inline-block;min-width:42px;max-width:100%;
      padding:6px 12px;border-radius:999px;font-weight:800;text-transform:uppercase;
      color:var(--pillText);outline:none;border:1px solid rgba(0,0,0,.05);
      background:#e6e6fa;
    }
    td{height:48px}
    td .pill, th .pill{margin:auto;}

    /* Header editable pill style */
    .headpill{
      background:#e0f2fe; font-weight:800; text-transform:none;
    }

    /* Color mapping */
    .M{background:#ffb3c6;}           /* Light Pink */
    .A{background:#d3d3d3;}
    .N1{background:#b6f7b0;}
    .N2{background:#3aa655;color:#fff;}
    .O{background:#ffffff;}
    .D1{background:#ffcc99;}
    .X{background:#c7d2fe;}
    .Y{background:#fde68a;}
    .Z{background:#bae6fd;}

    #status{margin:6px 16px 16px;color:#059669;font-weight:700;height:18px}
    @media (max-width:640px){ .topbar{padding:14px} .title{font-size:18px} }

    /* ===== Save-state visual helpers (added) ===== */
    .pill.saving { box-shadow: 0 0 0 3px rgba(59,130,246,0.12); border: 2px solid #3b82f6 !important; }
    .pill.saved  { box-shadow: 0 0 0 3px rgba(16,185,129,0.12); border: 2px solid #10b981 !important; }
    .pill.error  { box-shadow: 0 0 0 3px rgba(239,68,68,0.08); border: 2px solid #ef4444 !important; }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="topbar">
    <div class="titleWrap">
      <div class="logo">ðŸ“Š</div>
      <div>
        <div class="title">ATC Roster Management</div>
        <div class="subtitle">Manage your sheet safely with <b>Preparation</b>, <b>Updation</b> &amp; <b>Viewer</b> modes</div>
      </div>
    </div>
    <div class="modes">
      <button id="prepBtn" class="modeBtn inactive" onclick="openPasswordModal('preparation')">Preparation</button>
      <button id="updBtn"  class="modeBtn inactive" onclick="openPasswordModal('updation')">Updation</button>
      <button id="viewBtn" class="modeBtn active"  onclick="setMode('viewer')">Viewer</button>
    </div>
  </div>

  <!-- Top action buttons -->
  <div class="actions">
    <button id="finalizeBtn" class="btn">Finalize &amp; Send Roster</button>
    <button id="sendChangesBtn" class="btn warn" style="display:none;">Send Changes Email</button>
    <button id="sendUpdatesBtn" class="btn warn" style="display:none;">Send Updates</button>
  </div>

  <!-- Search + badge -->
  <div class="searchRow">
    <input id="searchInput" class="search" placeholder="ðŸ” Live search employees, shifts, etc." />
    <div id="modeBadge" class="modeBadge">Preparation Mode</div>
  </div>

  <!-- Table -->
  <div class="tableWrap" id="tableWrap">
    <div id="table-container" style="min-height:160px;display:flex;align-items:center;justify-content:center;">Loading dataâ€¦</div>
  </div>

  <div id="status"></div>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzTiFn8VKv2bSWDYgcnmaQEi49Y8pgG4JlvtFDFSu_GFtmrlhST2GMQEX7lH6XHQYAcyw/exec"; // <-- repla
    let currentMode = 'preparation';
    let dataCache = [];
    const debounceTimers = new Map();

    // ------ CONFIG ------
    const SAVE_DELAY = 600; // ms (was 25) â€” reduce backend spam
    const MAX_RETRIES = 2;  // automatic retries on failure

    function setMode(mode){
      currentMode = mode;
      document.getElementById('prepBtn').classList.toggle('active', mode==='preparation');
      document.getElementById('prepBtn').classList.toggle('inactive', mode!=='preparation');
      document.getElementById('updBtn').classList.toggle('active', mode==='updation');
      document.getElementById('updBtn').classList.toggle('inactive', mode!=='updation');
      document.getElementById('viewBtn').classList.toggle('active', mode==='viewer');
      document.getElementById('viewBtn').classList.toggle('inactive', mode!=='viewer');

      document.getElementById('finalizeBtn').style.display = (mode==='preparation') ? 'inline-block' : 'none';
      document.getElementById('sendChangesBtn').style.display = (mode==='updation') ? 'inline-block' : 'none';
      document.getElementById('sendUpdatesBtn').style.display = (mode==='updation') ? 'inline-block' : 'none';

      document.getElementById('modeBadge').textContent =
        (mode==='preparation') ? 'Preparation Mode' :
        (mode==='updation') ? 'Updation Mode' :
        'Viewer Mode';

      loadTable();
    }
    function requestModeChange(mode) {
      if (mode === 'viewer') {
        setMode('viewer');
        return;
      }

      const pwd = prompt(`Enter password for ${mode} mode:`);
      if (!pwd) return;

      google.script.run
        .withSuccessHandler(correct => {
          if (correct) {
            setMode(mode);
          } else {
            alert("Incorrect password!");
            setMode('viewer'); // fallback
          }
        })
        .checkPassword(mode, pwd);
    }

    // Handle paste â†’ force plain text only (prevents rich text/HTML insertion)
    document.addEventListener("paste", function(e) {
      const target = e.target;
      if (!target) return;
      if (target.isContentEditable) {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text/plain");
        // Insert as plain text at caret
        if (document.queryCommandSupported && document.queryCommandSupported("insertText")) {
          document.execCommand("insertText", false, text);
        } else {
          // fallback: append plain text
          const sel = window.getSelection();
          if (!sel.rangeCount) {
            target.appendChild(document.createTextNode(text));
          } else {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            range.insertNode(document.createTextNode(text));
            // move caret after inserted text
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        }
      }
    });

    function loadTable(){
      google.script.run.withSuccessHandler(values => {
        dataCache = values;
        renderTable(values);
      }).getSheetData();
    }

    function renderTable(values){
      if (!values || !values.length){
        document.getElementById('table-container').innerHTML = 'No data found.';
        return;
      }

      const headers = values[0]; 
      let html = '<table id="rosterTable"><thead><tr>';

      headers.forEach((h, idx) => {
        const editable = (currentMode === 'viewer') ? '' : 'contenteditable="true"';
        html += `
          <th>
            <div class="pill headpill" ${editable}
                 data-row="1" data-col="${idx+1}" data-header="true" data-original="${escapeHtml(h)}"
                 oninput="debouncedSave(this)" onblur="forceSave(this)">
              ${escapeHtml(h)}
            </div>
          </th>`;
      });
      html += '</tr></thead><tbody>';

      for (let r = 1; r < values.length; r++){
        html += '<tr>';
        for (let c = 0; c < headers.length; c++){
          const v = values[r][c] ?? '';
          const cls = pillClass(v);
          const editable = (currentMode === 'viewer') ? '' : 'contenteditable="true"';
          html += `
            <td>
              <div class="pill ${cls}" ${editable}
                   data-row="${r+1}" data-col="${c+1}" data-original="${escapeHtml(v)}"
                   oninput="debouncedSave(this)" onblur="forceSave(this)">
                ${escapeHtml(v)}
              </div>
            </td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';

      document.getElementById('table-container').innerHTML = html;

      // Reset scroll after table fully renders
      requestAnimationFrame(() => {
        const wrap = document.getElementById('tableWrap');
        if (wrap) wrap.scrollLeft = 0;

        const container = document.getElementById('table-container');
        if (container) container.scrollLeft = 0;
      });
    }

    function pillClass(val){
      const v = String(val || '').trim().toUpperCase();
      if (v === 'M')  return 'M';
      if (v === 'A')  return 'A';
      if (v === 'N1') return 'N1';
      if (v === 'N2') return 'N2';
      if (v === 'O')  return 'O';
      if (v === 'D1') return 'D1';
      const first = v[0] || '';
      if (first >= 'A' && first <= 'I') return 'X';
      if (first >= 'J' && first <= 'R') return 'Y';
      return 'A';
    }

    // Debounced save (uses SAVE_DELAY)
    function debouncedSave(el) {
      if (el.dataset.header !== 'true' && currentMode !== 'viewer') {
        el.className = `pill ${pillClass(el.innerText)}`;
      }
      showStatus('Savingâ€¦');
      const key = el.dataset.row + ':' + el.dataset.col;
      if (debounceTimers.has(key)) clearTimeout(debounceTimers.get(key));
      const t = setTimeout(() => saveCell(el), SAVE_DELAY);
      debounceTimers.set(key, t);
    }

    function saveCell(el, retries = MAX_RETRIES) {
      // If viewer, revert and warn
      if (currentMode === 'viewer') {
        el.innerText = el.dataset.original || '';
        alert("Excuse me Sir, You are not Authorized to change Data");
        return;
      }

      // Clear any previous click-retry handler (we'll re-add if final failure)
      el.onclick = null;

      const row = parseInt(el.dataset.row, 10);
      const col = parseInt(el.dataset.col, 10);
      const rawValue = el.innerText;
      const value = sanitize(rawValue);

      // Visual: saving
      el.classList.remove('error','saved');
      el.classList.add('saving');

      google.script.run
        .withSuccessHandler(res => {
          el.classList.remove('saving');
          if (res && res.status === 'saved') {
            // If server returned formatted newValue (headers), prefer that
            if (res.newValue !== undefined) {
              el.innerText = res.newValue;
              el.dataset.original = res.newValue;
            } else {
              el.dataset.original = value;
            }
            // Brief success flash
            el.classList.add('saved');
            setTimeout(() => el.classList.remove('saved'), 800);
            showStatus('Saved');
          } else if (res && res.status === 'nochange') {
            // nothing changed
            el.classList.remove('saving');
            showStatus('No change');
          } else {
            // treat as error
            handleSaveError(el, retries);
          }
        })
        .withFailureHandler(() => {
          el.classList.remove('saving');
          handleSaveError(el, retries);
        })
        .updateCell(currentMode, row, col, value);
    }

    function handleSaveError(el, retries) {
      el.classList.remove('saving');
      el.classList.add('error');
      showStatus('Save failed');

      if (retries > 0) {
        // simple backoff: 1.5s, 3s, ... (depends on MAX_RETRIES)
        const backoff = 1500 * (MAX_RETRIES - retries + 1);
        setTimeout(() => {
          // remove error state before retry so UI shows saving state properly
          el.classList.remove('error');
          saveCell(el, retries - 1);
        }, backoff);
      } else {
        // Final failure: allow manual retry via click
        el.title = "Save failed. Click to retry.";
        el.onclick = (ev) => {
          ev.stopPropagation();
          el.classList.remove('error');
          saveCell(el, MAX_RETRIES);
        };
      }
    }

    function forceSave(el){
      const key = el.dataset.row + ':' + el.dataset.col;
      if (debounceTimers.has(key)) {
        clearTimeout(debounceTimers.get(key));
        debounceTimers.delete(key);
      }
      saveCell(el);
    }

    // Buttons
    document.getElementById('sendChangesBtn').onclick = () => {
      google.script.run.withSuccessHandler(msg => alert(msg)).sendChangesEmail();
    };
    document.getElementById('sendUpdatesBtn').onclick = () => {
      google.script.run.withSuccessHandler(msg => alert(msg)).sendUpdateEmails();
    };
        document.getElementById('finalizeBtn').onclick = () => {
      if (currentMode === 'preparation') {
        // Send Prepared Roster
        google.script.run.withSuccessHandler(msg => alert(msg)).sendRosterEmail();
      } else if (currentMode === 'updation') {
        // Send Final Roster
        google.script.run.withSuccessHandler(msg => alert(msg)).sendFinalRoster();
      }
    };


    // Live search
    document.getElementById('searchInput').addEventListener('input', () => {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const rows = document.querySelectorAll('#rosterTable tbody tr');
      rows.forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    function escapeHtml(s){
      return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }
    // stronger sanitizer: strip any tags and normalize spaces
    function sanitize(s){
      return String(s ?? '')
        .replace(/<[^>]*>/g, '')   // remove any HTML tags
        .replace(/\u00A0/g,' ')
        .replace(/\s+\n/g,' ')
        .replace(/\n+/g,' ')
        .trim();
    }
    function showStatus(msg){
      const el = document.getElementById('status');
      el.textContent = msg;
      if (msg) setTimeout(() => { el.textContent=''; }, 1200);
    }

    // Init
    window.onload = () => setMode('viewer');

    // Password modal logic (unchanged from original) â€“ still calls backend when requesting passwords
    let pendingMode = null; // track which mode we're unlocking

    function openPasswordModal(mode) {
      pendingMode = mode;
      const titleEl = document.getElementById("modalTitle");
      const subtitleEl = document.getElementById("modalSubtitle");

      if (mode === "preparation") {
        titleEl.innerHTML = "ðŸŸ¡ Enter Preparation Password";
        subtitleEl.textContent = "Access restricted: Please enter the Preparation Mode password.";
      } else if (mode === "updation") {
        titleEl.innerHTML = "ðŸ”´ Enter Updation Password";
        subtitleEl.textContent = "Access restricted: Please enter the Updation Mode password.";
      }

      document.getElementById("passwordModal").style.display = "flex";
      document.getElementById("modePassword").value = "";
      document.getElementById("modePassword").focus();
    }

    function closeModal() {
      document.getElementById("passwordModal").style.display = "none";
    }

    function submitPassword() {
      const input = document.getElementById("modePassword");
      const entered = input.value;

      // Validate server-side (do not store passwords client-side)
      google.script.run
        .withSuccessHandler(correct => {
          if (correct) {
            closeModal();
            setMode(pendingMode);
          } else {
            input.classList.add("shake");
            setTimeout(() => input.classList.remove("shake"), 500);
            input.value = "";
            input.focus();
          }
        })
        .checkPassword(pendingMode, entered);
    }

    // ðŸ”¥ Hide Google Apps Script banner automatically (unchanged)
    window.addEventListener("load", () => {
      setTimeout(() => {
        const gasBanner = document.querySelector("iframe + div"); 
        const gasCross = document.querySelector("iframe + div .apps-script-notification-dismiss");

        if (gasBanner) gasBanner.style.display = "none";
        if (gasCross) gasCross.click(); // simulate user closing
      }, 1000);
    });

  </script>

  <!-- Password Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2 id="modalTitle" style="display:flex; align-items:center; gap:10px; margin-top:0;">
      ðŸ”’ Enter Password
    </h2>
    <p id="modalSubtitle">Please enter the password to continue.</p>
    <input id="modePassword" type="password" placeholder="Enter password..." />
    <div style="margin-top:16px; text-align:right;">
      <button onclick="submitPassword()" class="btn">Submit</button>
    </div>
  </div>
</div>

</body>
</html>
